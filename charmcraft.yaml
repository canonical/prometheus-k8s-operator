# Copyright 2021 Canonical Ltd.
# See LICENSE file for licensing details.
name: prometheus-k8s
type: charm
summary: Prometheus for Kubernetes clusters
description: |
  Prometheus is an open source monitoring solution. Prometheus
  supports aggregating high dimensional data and exposes a powerful
  query language PromQL. This charm deploys and operates Prometheus on
  Kubernetes clusters. Prometheus can raise alerts through a relation
  with the Alertmanager charm. Alerting rules for Prometheus need to
  be provided through a relation with the application that requires
  alerting. Prometheus provides its own dashboard for data
  visualization but a richer visualization interface may be obtained
  through a relation with the Grafana charm.

links:
  documentation: https://discourse.charmhub.io/t/prometheus-k8s-docs-index/5803
  website: https://charmhub.io/prometheus-k8s
  source: https://github.com/canonical/prometheus-k8s-operator
  issues: https://github.com/canonical/prometheus-k8s-operator/issues

assumes:
  - k8s-api
  - juju >= 3.6

platforms:
  ubuntu@24.04:amd64:

parts:
  charm:
    source: .
    plugin: uv
    build-packages: [git]
    build-snaps: [astral-uv]
    override-build: |
      craftctl default
      git describe --always > $CRAFT_PART_INSTALL/version
  cos-tool:
    plugin: dump
    source: https://github.com/canonical/cos-tool/releases/latest/download/cos-tool-${CRAFT_ARCH_BUILD_FOR}
    source-type: file
    permissions:
      - path: cos-tool-${CRAFT_ARCH_BUILD_FOR}
        mode: "755"

containers:
  prometheus:
    resource: prometheus-image
    mounts:
      - storage: database
        location: /var/lib/prometheus

resources:
  prometheus-image:
    type: oci-image
    description: Container image for Prometheus
    upstream-source: ubuntu/prometheus@sha256:e945d24df7b2f591c056a84af143dd13ac9132aa353c14a9bd71bec6faf0b966  # renovate: oci-image tag: 2.53-24.04

storage:
  database:
    type: filesystem

provides:
  self-metrics-endpoint:
    interface: prometheus_scrape
    optional: true
    description: |
      Expose Prometheus' internal metrics for self-monitoring purposes.
  grafana-source:
    interface: grafana_datasource
    optional: true
    description: |
      Integrate Prometheus in Grafana as a datasource.
  grafana-dashboard:
    interface: grafana_dashboard
    optional: true
    description: |
      Forwards the built-in Grafana dashboard(s) for monitoring Prometheus.
  receive-remote-write:
    interface: prometheus_remote_write
    optional: true
    description: |
      Expose a Prometheus-remote-write-compatible endpoint to receive metrics.
  send-datasource:
    interface: grafana_datasource_exchange
    optional: true
    description: |
      Integration to share with other COS components this charm's grafana datasources, and receive theirs.
  prometheus-api:
    interface: prometheus_api
    optional: true
    description: |
      The integration point for other charms to consume Prometheus's API, for example so they can query the database.
  slos:
    interface: slo
    optional: true
    description: |
      Integration to provide SLO specs to Sloth for SLO based alerting and dashboards.

requires:
  metrics-endpoint:
    interface: prometheus_scrape
    optional: true
    description: |
      Integration to scrape the metrics and required endpoints of another charm.
  alertmanager:
    interface: alertmanager_dispatch
    optional: true
    description: |
      Configure Prometheus to utilize an external Alertmanager to notify the user when an alert is triggered.
  ingress:
    interface: ingress_per_unit
    optional: true
    limit: 1
    description: |
      Integration to obtain an ingressed address to access Prometheus from outside the model.
  catalogue:
    interface: catalogue
    optional: true
    limit: 1
    description: |
      Integration to help users discover Mimir's deployment.
  certificates:
    interface: tls-certificates
    optional: true
    limit: 1
    description: |
      Obtain a CA and a server certificate for Prometheus to use for TLS.
      The same CA cert is used for all in-cluster requests, e.g.:
      - (client) scraping targets for self-monitoring
      - (client) posting alerts to alertmanager server
      - (server) serving data to grafana
  charm-tracing:
    interface: tracing
    optional: true
    limit: 1
    description: |
      Enables sending charm traces to a distributed tracing backend such as Tempo.
  workload-tracing:
    interface: tracing
    optional: true
    limit: 1
    description: |
      Enables sending workload traces (internal Prometheus traces) to a distributed tracing backend such as Tempo.
  receive-ca-cert:
    interface: certificate_transfer
    optional: true
    description: |
      For Prometheus to create a trusted (TLS) connection with servers
      it scrapes, it needs to trust the CA that signed the server it
      talks to. CA certs forwarded over this relation are installed in
      the root CA store of the prometheus container.

peers:
  prometheus-peers:
    interface: prometheus_peers

config:
  options:
    log_level:
      description: |
        Prometheus server log level (only log messages with the given severity
        or above). Must be one of: [debug, info, warn, error, fatal].
        If not set, the Prometheus default one (info) will be used.
      type: string
      default: info
    web_external_url:
      description: |
        DEPRECATED. This config option is no longer used, in favor of "skipPrefix".

        The URL under which Prometheus is externally reachable (for example,
        if Prometheus is served via a reverse proxy).
        Used for generating relative and absolute links back to
        Prometheus itself. If the URL has a path portion, it will be used to
        prefix all HTTP endpoints served by Prometheus.

        The URL provided must point to the root of the Prometheus web application,
        e.g.:

        http://foo.bar/

        Note, do *not* set this configuration to a specific to an API path, e.g.,

        http://foo.bar//api/v1/write  # DO NOT TRY THIS AT HOME

        This configuration option takes precedence over the URL provided over
        the "ingress" relation.
      type: string
      default: ""
    metrics_retention_time:
      description: |
        How long to retain samples in the storage.
        Units Supported: y, w, d, h, m, s
      type: string
      default: 15d
    maximum_retention_size:
      description: |
        The maximum storage to retain, expressed as a percentage (0-100) of the PVC capacity (e.g.
        "80%").
        The percentage value is then converted to bytes and passed to prometheus with the
        `--storage.tsdb.retention.size` argument.
        If this field is set to an invalid value, the `--storage.tsdb.retention.size` argument is dropped. In such cases, retention is only determined by `metrics_retention_time`. 
        Default is 80%.
      type: string
      default: "80%"
    metrics_wal_compression:
      description: |
        This flag enables compression of the write-ahead log (WAL).
        Depending on your data, you can expect the WAL size to be
        halved with little extra cpu load.
      type: boolean
      default: false
    evaluation_interval:
      description: |
        How frequently rules will be evaluated.
      type: string
      default: 1m
    cpu:
      description: |
        K8s cpu resource limit, e.g. "1" or "500m". Default is unset (no limit). This value is used
        for the "limits" portion of the resource requirements (the "requests" portion is
        automatically deduced from it).
        See https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/
      type: string
    memory:
      description: |
        K8s memory resource limit, e.g. "1Gi". Default is unset (no limit). This value is used
        for the "limits" portion of the resource requirements (the "requests" portion is
        automatically deduced from it).
        See https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/
      type: string
    max_global_exemplars_per_user:
      default: 0
      description: |
       The global limit for the number of exemplars.
       When unset or set to a non-positive number, exemplar storage is disabled.
       Otherwise, the value is set to the greater of the setpoint or 100,000.
       Ref: https://prometheus.io/docs/prometheus/latest/feature_flags/#exemplars-storage
      type: int
    slos:
      default: ""
      type: string
      description: |
        Provides SLO (Service Level Objective) specifications to Sloth for generating 
        Prometheus recording and alerting rules.

actions:
  validate-configuration:
    description: |
      Run `promtool` inside the workload to validate the Prometheus configuration file, and
      return the resulting output. This can be used to troubleshoot a Prometheus instance
      which will not start, or misbehaves, due to a bad configuration.
  get-slo-template:
    description: |
      Returns a template SLO specification for Prometheus with placeholders for customization.
      The template includes example SLOs for key metrics and KPIs such as #TODO.
      
      Usage:
        # Extract template to file (recommended):
        juju run prometheus-k8s/0 get-slo-template --format=json | jq -r '.template' > prometheus-slo.yaml
        
        # Then edit prometheus-slo.yaml to fill in the <OBJECTIVE> placeholder for each SLO.
        
        # Apply the configuration:
        juju config prometheus-k8s slos="$(cat prometheus-slo.yaml)"
